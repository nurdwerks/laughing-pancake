<!DOCTYPE html>
<html>
<head>
    <title>Rust Chess AI</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #282a36;
            color: #f8f8f2;
            margin: 0;
            padding: 1em;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 2em);
        }
        .main-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
            gap: 1em;
        }
        #status-bar {
            display: flex;
            justify-content: space-around;
            flex-shrink: 0;
        }
        .status-gauge {
            border: 1px solid #6272a4;
            padding: 0.5em;
            width: 30%;
            text-align: center;
        }
        progress {
            width: 80%;
        }
        #matches-container {
            display: flex;
            flex-grow: 1;
            min-height: 0;
            gap: 1em;
        }
        .match-pane {
            display: flex;
            flex-direction: column;
            border: 1px solid #6272a4;
            flex: 1;
            min-width: 0;
        }
        .match-header {
            padding: 0.5em;
            background-color: #44475a;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .board-container {
            flex-grow: 1;
            padding: 0.5em;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .san-container {
            height: 20%;
            border-top: 1px solid #6272a4;
            padding: 0.5em;
            overflow-y: auto;
            word-wrap: break-word;
        }
        #bottom-container {
            display: flex;
            height: 25%;
            gap: 1em;
            flex-shrink: 0;
        }
        #log-container, #workers-container {
            border: 1px solid #6272a4;
            flex: 1;
            overflow-y: auto;
            padding: 0.5em;
            display: flex;
            flex-direction: column;
        }
        h2 {
            margin-top: 0;
            font-size: 1em;
            border-bottom: 1px solid #44475a;
            padding-bottom: 0.2em;
            flex-shrink: 0;
        }
        .scroll-content {
            overflow-y: auto;
            flex-grow: 1;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            aspect-ratio: 1;
            /* Make it take up most of the container, but not all */
            width: 95%;
            /* Also constrain by height on portrait screens */
            max-width: 95vh;
        }
        .square {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            /* Use vmin to make font size scale with the smallest screen dimension */
            font-size: 4vmin;
        }
        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .piece {
            text-shadow: 0 0 2px #000; /* Outline for better visibility */
        }
        .white-piece { color: #f8f8f2; }
        .black-piece { color: #50fa7b; }
        #buttons {
            margin-top: 1em;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="status-bar">
            <div id="generation-status" class="status-gauge"></div>
            <div id="cpu-status" class="status-gauge"></div>
            <div id="mem-status" class="status-gauge"></div>
        </div>

        <div id="matches-container">
            <!-- Match panes will be dynamically inserted here -->
        </div>

        <div id="bottom-container">
            <div id="log-container">
                <h2>Log</h2>
                <div id="log-content" class="scroll-content"></div>
            </div>
            <div id="workers-container">
                <h2>Running Threads</h2>
                <div id="workers-content" class="scroll-content"></div>
            </div>
        </div>
    </div>

    <div id="buttons">
        <button id="request_quit">Request Quit</button>
        <button id="force_quit">Force Quit</button>
    </div>

    <script>
        const PIECE_SYMBOLS = {
            'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
            'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
        };

        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);

        ws.onmessage = (event) => {
            const state = JSON.parse(event.data);
            updateStatusBar(state);
            updateMatches(state.active_matches);
            updateLog(state.evolution_log);
            updateWorkers(state.evolution_workers);
        };

        document.getElementById('request_quit').onclick = () => ws.send('request_quit');
        document.getElementById('force_quit').onclick = () => ws.send('force_quit');

        function updateStatusBar(state) {
            // Generation Status
            const genDiv = document.getElementById('generation-status');
            const progress = state.evolution_total_matches > 0 ? (state.evolution_matches_completed / state.evolution_total_matches) : 0;
            genDiv.innerHTML = `
                <div>Generation: ${state.evolution_current_generation} | Matches: ${state.evolution_matches_completed}/${state.evolution_total_matches}</div>
                <progress value="${progress}" max="1"></progress>
            `;

            // CPU Status
            const cpuDiv = document.getElementById('cpu-status');
            cpuDiv.innerHTML = `
                <div>CPU Usage</div>
                <progress value="${state.cpu_usage}" max="100"></progress>
                <span>${state.cpu_usage.toFixed(2)}%</span>
            `;

            // Memory Status
            const memDiv = document.getElementById('mem-status');
            const memUsedGb = state.memory_usage / (1024 * 1024 * 1024);
            const memTotalGb = state.total_memory / (1024 * 1024 * 1024);
            memDiv.innerHTML = `
                <div>Memory Usage</div>
                <progress value="${state.memory_usage}" max="${state.total_memory}"></progress>
                <span>${memUsedGb.toFixed(2)} / ${memTotalGb.toFixed(2)} GB</span>
            `;
        }

        function updateMatches(matches) {
            const container = document.getElementById('matches-container');
            container.innerHTML = ''; // Clear existing matches

            const sortedMatches = Object.entries(matches).sort(([idA], [idB]) => idA - idB);

            if (sortedMatches.length === 0) {
                container.innerHTML = '<div style="text-align: center; width: 100%;">Waiting for matches to start...</div>';
                return;
            }

            for (const [id, match] of sortedMatches) {
                const pane = document.createElement('div');
                pane.className = 'match-pane';

                const header = document.createElement('div');
                header.className = 'match-header';
                header.textContent = `Match ${id}: ${match.white_player.split('.')[0]} vs ${match.black_player.split('.')[0]}`;

                const boardContainer = document.createElement('div');
                boardContainer.className = 'board-container';
                boardContainer.innerHTML = renderBoard(match.board);

                const sanContainer = document.createElement('div');
                sanContainer.className = 'san-container';
                sanContainer.innerHTML = `<strong>Eval:</strong> ${match.eval} | <strong>Material:</strong> ${match.material}<br>${match.san}`;

                pane.appendChild(header);
                pane.appendChild(boardContainer);
                pane.appendChild(sanContainer);
                container.appendChild(pane);
            }
        }

        function renderBoard(fen) {
            const [boardState] = fen.split(' ');
            const rows = boardState.split('/');
            let html = '<div class="board">';

            for (let i = 0; i < 8; i++) {
                const row = rows[i];
                for (let j = 0; j < 8; j++) {
                    const isDark = (i + j) % 2 !== 0;
                    html += `<div class="square ${isDark ? 'dark' : 'light'}">`;

                    const piece = getPieceAt(row, j);
                    if (piece) {
                        const colorClass = piece === piece.toUpperCase() ? 'white-piece' : 'black-piece';
                        html += `<span class="piece ${colorClass}">${PIECE_SYMBOLS[piece]}</span>`;
                    }
                    html += '</div>';
                }
            }
            html += '</div>';
            return html;
        }

        // This is a helper because FEN is tricky with the numbers for empty squares
        function getPieceAt(fenRow, fileIndex) {
            let currentFile = 0;
            for (const char of fenRow) {
                if (isNaN(parseInt(char))) { // It's a piece
                    if (currentFile === fileIndex) {
                        return char;
                    }
                    currentFile++;
                } else { // It's a number for empty squares
                    const emptySquares = parseInt(char);
                    if (fileIndex >= currentFile && fileIndex < currentFile + emptySquares) {
                        return null;
                    }
                    currentFile += emptySquares;
                }
            }
            return null; // Should not be reached in a valid FEN
        }


        function updateLog(log) {
            const container = document.getElementById('log-content');
            container.innerHTML = log.join('<br>');
            container.scrollTop = container.scrollHeight;
        }

        function updateWorkers(workers) {
            const container = document.getElementById('workers-content');
            if (workers.length === 0) {
                container.innerHTML = 'Waiting for AI move...';
                return;
            }
            container.innerHTML = workers
                .sort((a, b) => b.elapsed_time - a.elapsed_time)
                .map(w => `<div>${w.elapsed_time.toFixed(2)}s: ${w.name}</div>`)
                .join('');
        }

    </script>
</body>
</html>